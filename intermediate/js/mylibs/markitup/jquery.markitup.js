(function(c){c.fn.markItUp=function(n,e){var b,f,i,r;f=i=r=!1;b={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:!1,previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};c.extend(b,n,e);b.root||c("script").each(function(f,i){miuScript=c(i).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);
if(miuScript!==null)b.root=miuScript[1]});return this.each(function(){function e(a,c){return c?a.replace(/("|')~\//g,"$1"+b.root):a.replace(/^~\//,b.root)}function n(a){var j=c("<ul></ul>"),b=0;c("li:hover > ul",j).css("display","block");c.each(a,function(){var a=this,d="",h,f;h=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)d=c('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(j);else{b++;for(f=t.length-1;f>=0;f--)d+=t[f]+
"-";d=c('<li class="markItUpButton markItUpButton'+d+b+" "+(a.className||"")+'"><a href="" '+key+' title="'+h+'">'+(a.name||"")+"</a></li>").bind("contextmenu",function(){return!1}).click(function(){return!1}).bind("focusin",function(){g.focus()}).mouseup(function(){a.call&&eval(a.call)();setTimeout(function(){s(a)},1);return!1}).hover(function(){c("> ul",this).show();c(document).one("click",function(){c("ul ul",v).hide()})},function(){c("> ul",this).hide()}).appendTo(j);a.dropMenu&&(t.push(b),c(d).addClass("markItUpDropMenu").append(n(a.dropMenu)))}});
t.pop();return j}function F(a){return a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return r===!0?b[1]!==void 0?b[1]:b[0]:b[1]===void 0?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,c){var b=c.split(":!:");if(u===!0)return!1;value=prompt(b[0],b[1]?b[1]:"");value===null&&(u=!0);return value})):""}function l(a){c.isFunction(a)&&(a=a(p));return F(a)}function w(){var a=l(m.openWith),c=l(m.placeHolder),b=l(m.replaceWith),d=l(m.closeWith),g=l(m.openBlockWith),
h=l(m.closeBlockWith);if(b!=="")block=a+b+d;else if(selection===""&&c!=="")block=a+c+d;else{for(var f=selection.split(/\r?\n/),e=[],i=0;i<f.length;i++){line=f[i];var k;(k=line.match(/ *$/))?e.push(a+line.replace(/ *$/g,"")+d+k):e.push(a+line+d)}block=e.join("\n")}block=g+block+h;return{block:block,openWith:a,replaceWith:b,placeHolder:c,closeWith:d}}function s(a){var j,e,o;p=m=a;x();c.extend(p,{line:"",root:b.root,textarea:d,selection:selection||"",caretPosition:h,ctrlKey:f,shiftKey:i,altKey:r});l(b.beforeInsert);
l(m.beforeInsert);(f===!0&&i===!0||a.multiline===!0)&&l(m.beforeMultiInsert);c.extend(p,{line:1});if(f===!0&&i===!0){lines=selection.split(/\r?\n/);for(j=0,e=lines.length,o=0;o<e;o++)c.trim(lines[o])!==""?(c.extend(p,{line:++j,selection:lines[o]}),lines[o]=w(lines[o]).block):lines[o]="";string={block:lines.join("\n")};start=h;j=string.block.length+(c.browser.opera?e-1:0)}else f===!0?(string=w(selection),start=h+string.openWith.length,j=string.block.length-string.openWith.length-string.closeWith.length,
j-=string.block.match(/ $/)?1:0,j-=z(string.block)):i===!0?(string=w(selection),start=h,j=string.block.length,j-=z(string.block)):(string=w(selection),start=h+string.block.length,j=0,start-=z(string.block));if(selection===""&&string.replaceWith==="")k+=B(string.block),start=h+string.openWith.length,j=string.block.length-string.openWith.length-string.closeWith.length,k=g.val().substring(h,g.val().length).length,k-=B(g.val().substring(0,h));c.extend(p,{caretPosition:h,scrollPosition:y});string.block!==
selection&&u===!1?(e=string.block,document.selection?document.selection.createRange().text=e:d.value=d.value.substring(0,h)+e+d.value.substring(h+selection.length,d.value.length),C(start,j)):k=-1;x();c.extend(p,{line:"",selection:selection});(f===!0&&i===!0||a.multiline===!0)&&l(m.afterMultiInsert);l(m.afterInsert);l(b.afterInsert);q&&b.previewAutoRefresh&&G();i=r=f=u=!1}function B(a){return c.browser.opera?a.length-a.replace(/\n*/g,"").length:0}function z(a){return c.browser.msie?a.length-a.replace(/\r*/g,
"").length:0}function C(a,b){if(d.createTextRange){if(c.browser.opera&&c.browser.version>=9.5&&b==0)return!1;range=d.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else d.setSelectionRange&&d.setSelectionRange(a,a+b);d.scrollTop=y;d.focus()}function x(){d.focus();y=d.scrollTop;if(document.selection)if(selection=document.selection.createRange().text,c.browser.msie){var a=document.selection.createRange(),b=a.duplicate();b.moveToElementText(d);
for(h=-1;b.inRange(a);)b.moveStart("character"),h++}else h=d.selectionStart;else h=d.selectionStart,selection=d.value.substring(h,d.selectionEnd);return selection}function G(){if(b.previewParser&&typeof b.previewParser==="function"){var a=b.previewParser(g.val());A(e(a,1))}else b.previewParserPath!==""?c.ajax({type:"POST",dataType:"text",global:!1,url:b.previewParserPath,data:b.previewParserVar+"="+encodeURIComponent(g.val()),success:function(a){A(e(a,1))}}):H||c.ajax({url:b.previewTemplatePath,dataType:"text",
global:!1,success:function(a){A(e(a,1).replace(/<\!-- content --\>/g,g.val()))}});return!1}function A(a){if(q.document){try{sp=q.document.documentElement.scrollTop}catch(b){sp=0}q.document.open();q.document.write(a);q.document.close();q.document.documentElement.scrollTop=sp}}function D(a){i=a.shiftKey;r=a.altKey;f=!a.altKey||!a.ctrlKey?a.ctrlKey||a.metaKey:!1;if(a.type==="keydown"){if(f===!0&&(li=c('a[accesskey="'+String.fromCharCode(a.keyCode)+'"]',v).parent("li"),li.length!==0))return f=!1,setTimeout(function(){li.triggerHandler("mouseup")},
1),!1;if(a.keyCode===13||a.keyCode===10)return f===!0?(f=!1,s(b.onCtrlEnter),b.onCtrlEnter.keepDefault):i===!0?(i=!1,s(b.onShiftEnter),b.onShiftEnter.keepDefault):(s(b.onEnter),b.onEnter.keepDefault);if(a.keyCode===9)return i==!0||f==!0||r==!0?!1:k!==-1?(x(),k=g.val().length-k,C(k,0),k=-1,!1):(s(b.onTab),b.onTab.keepDefault)}}var g,d,t,y,h,k,m,p,v,E,q,H,u;g=c(this);d=this;t=[];u=!1;y=h=0;k=-1;b.previewParserPath=e(b.previewParserPath);b.previewTemplatePath=e(b.previewTemplatePath);(function(){nameSpace=
id="";b.id?id='id="'+b.id+'"':g.attr("id")&&(id='id="markItUp'+g.attr("id").substr(0,1).toUpperCase()+g.attr("id").substr(1)+'"');b.nameSpace&&(nameSpace='class="'+b.nameSpace+'"');g.wrap("<div "+nameSpace+"></div>");g.wrap("<div "+id+' class="markItUp"></div>');g.wrap('<div class="markItUpContainer"></div>');g.addClass("markItUpEditor");v=c('<div class="markItUpHeader"></div>').insertBefore(g);c(n(b.markupSet)).appendTo(v);E=c('<div class="markItUpFooter"></div>').insertAfter(g);b.resizeHandle===
!0&&c.browser.safari!==!0&&(resizeHandle=c('<div class="markItUpResizeHandle"></div>').insertAfter(g).bind("mousedown",function(a){var b=g.height(),d=a.clientY,e,f;e=function(a){g.css("height",Math.max(20,a.clientY+b-d)+"px");return!1};f=function(){c("html").unbind("mousemove",e).unbind("mouseup",f);return!1};c("html").bind("mousemove",e).bind("mouseup",f)}),E.append(resizeHandle));g.keydown(D).keyup(D);g.bind("insertion",function(a,b){b.target!==!1&&x();d===c.markItUp.focused&&s(b)});g.focus(function(){c.markItUp.focused=
this})})()})};c.fn.markItUpRemove=function(){return this.each(function(){var n=c(this).unbind().removeClass("markItUpEditor");n.parent("div").parent("div.markItUp").parent("div").replaceWith(n)})};c.markItUp=function(n){var e={target:!1};c.extend(e,n);if(e.target)return c(e.target).each(function(){c(this).focus();c(this).trigger("insertion",[e])});else c("textarea").trigger("insertion",[e])}})(jQuery);
